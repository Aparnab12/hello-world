- name: b2b.inventoryupdates.ish.npd.rules
  rules:
    - alert: b2b-inventoryupdates-ish-PodDown-NonProd
      expr: (sum(kube_pod_container_info{container="b2b-inventoryupdates-ish", namespace="stg"}) by (role, env, namespace, container)) < 3 OR absent(kube_pod_container_info{container="b2b-inventoryupdates-ish", role="eks", env="nonprod", namespace="stg"}) == 1
      for: 2m
      labels:
        owner: retail-b2b
        severity: warning
      annotations:
        identifier: '{{ $labels.role }}/{{ $labels.env}}/{{ $labels.namespace}}'
        description: 'Warning: One or more pod(s) for {{ $labels.container }} in {{ $labels.namespace }} seems to be down. Current pod count is {{ $value }}'
        summary: 'Host {{ $labels.container }} has not been reachable for 2 minutes'
    - alert: b2b-inventoryupdates-ish-PodDown-NonProd
      expr: (sum(kube_pod_container_info{container="b2b-inventoryupdates-ish", namespace="stg"}) by (role, env, namespace, container)) < 3 OR absent(kube_pod_container_info{container="b2b-inventoryupdates-ish", role="eks", env="nonprod", namespace="stg"}) == 1
      for: 5m
      labels:
        owner: retail-b2b
        severity: critical
      annotations:
        identifier: '{{ $labels.role }}/{{ $labels.env}}/{{ $labels.namespace}}'
        description: 'Critical: One or more pod(s) for {{ $labels.container }} in {{ $labels.namespace }} seems to be down. Current pod count is {{ $value }}'
        summary: 'Host {{ $labels.container }} has not been reachable for 5 minutes'
    - alert: b2b-inventoryupdates-ish-AllPodDown-NonProd
      expr: (sum(kube_pod_container_info{container="b2b-inventoryupdates-ish", namespace="stg"}) by (role, env, namespace, container)) == 0 OR absent(kube_pod_container_info{container="b2b-inventoryupdates-ish", role="eks", env="nonprod", namespace="stg"}) == 1
      for: 2m
      labels:
        owner: retail-b2b
        severity: warning
      annotations:
        identifier: '{{ $labels.role }}/{{ $labels.env}}/{{ $labels.namespace}}'
        description: 'Warning: All Pods for {{ $labels.container }} in {{ $labels.namespace }} seems to be down. Current pod count is {{ $value }}'
        summary: 'Host {{ $labels.container }} has not been reachable for 2 minutes'
    - alert: b2b-inventoryupdates-ish-AllPodDown-NonProd
      expr: (sum(kube_pod_container_info{container="b2b-inventoryupdates-ish", namespace="stg"}) by (role, env, namespace, container)) == 0 OR absent(kube_pod_container_info{container="b2b-inventoryupdates-ish", role="eks", env="nonprod", namespace="stg"}) == 1
      for: 5m
      labels:
        owner: retail-b2b
        severity: critical
      annotations:
        identifier: '{{ $labels.role }}/{{ $labels.env}}/{{ $labels.namespace}}'
        description: 'Critical: All Pods for {{ $labels.container }} in {{ $labels.namespace }} seems to be down. Current pod count is {{ $value }}'
        summary: 'Host {{ $labels.container }} has not been reachable for 5 minutes'
    - alert: b2b-inventoryupdates-ish-AppDown
      expr: (b2b_inventoryupdates_ish_application_health{job="b2b-inventoryupdates-ish", env="stg"}) == 0
      for: 2m
      labels:
        owner: retail-b2b
        severity: warning
      annotations:
        identifier: '{{ $labels.env}}/{{ $labels.role}}'
        description: 'Warning: Consumer Application status for {{ $labels.job }} in {{ $labels.env }} seems to be down for 2 minutes.'
        summary: 'Status of {{ $labels.job }} in {{ $labels.env }} seems to be down.'
    - alert: b2b-inventoryupdates-ish-AppDown
      expr: (b2b-inventoryupdates-ish_application_health{job="b2b-inventoryupdates-ish", env="stg"}) == 0
      for: 5m
      labels:
        owner: retail-b2b
        severity: critical
      annotations:
        identifier: '{{ $labels.env}}/{{ $labels.role}}'
        description: 'Critical: Consumer Application status for {{ $labels.job }} in {{ $labels.env }} seems to be down for 5 minutes.'
        summary: 'Status of {{ $labels.job }} in {{ $labels.env }} seems to be down.'
    - alert: b2b-inventoryupdates-ish-CpuUsageAlert-Stg
      expr: (kube_metrics_server_pods_cpu{pod_container_name="b2b-inventoryupdates-ish", pod_namespace="stg"} / (1000000 * 1000)) > 2.8
      for: 5m
      labels:
        owner: retail-b2b
        severity: warning
      annotations:
        identifier: '{{ $labels.pod_namespace }}/{{ $labels.env }}/{{ $labels.role }}/{{ $labels.instance }}'
        description: 'Warning: CPU Usage exceeds 70%. `{{ $labels.pod_namespace }}/{{ $labels.role }}/{{ $labels.instance }}`'
        summary: 'CPU usage is high: `{{ $labels.pod_namespace }}/{{ $labels.role }}/{{ $labels.instance }}`'
    - alert: b2b-inventoryupdates-ish-CpuUsageAlert-Stg
      expr: (kube_metrics_server_pods_cpu{pod_container_name="b2b-inventoryupdates-ish", pod_namespace="stg"} / (1000000 * 1000)) > 3.6
      for: 10m
      labels:
        owner: retail-b2b
        severity: critical
      annotations:
        identifier: '{{ $labels.pod_namespace }}/{{ $labels.env }}/{{ $labels.role }}/{{ $labels.instance }}'
        description: 'Critical: CPU Usage exceeds 90%. `{{ $labels.pod_namespace }}/{{ $labels.role }}/{{ $labels.instance }}`'
        summary: 'CPU usage is very high: `{{ $labels.pod_namespace }}/{{ $labels.role }}/{{ $labels.instance }}`'
    - alert: b2b-inventoryupdates-ish-MemoryUsageAlert-Stg
      expr: (avg(kube_metrics_server_pods_mem{pod_container_name="b2b-inventoryupdates-ish", pod_namespace="stg"}) by (role, env, instance, pod_namespace, pod_container_name)) > (4.2 * 1024 * 1024 * 1024)
      for: 5m
      labels:
        owner: retail-b2b
        severity: warning
      annotations:
        identifier: '{{ $labels.pod_namespace }}/{{$labels.pod_container_name}}/{{ $labels.env }}/{{ $labels.role }}/{{ $labels.instance }}'
        description: 'warning: Memory Usage exceeds 70%. `{{ $labels.pod_namespace }}/{{$labels.pod_container_name}}/{{ $labels.role }}/{{ $labels.instance }}/{{ $labels.env }}`'
        summary: 'Memory usage is high: `{{ $labels.pod_namespace }}/{{$labels.pod_container_name}}/{{ $labels.role }}/{{ $labels.instance }}/{{ $labels.env }}`'
    - alert: b2b-inventoryupdates-ish-MemoryUsageAlert-Stg
      expr: (avg(kube_metrics_server_pods_mem{pod_container_name="b2b-inventoryupdates-ish", pod_namespace="stg"}) by (role, env, instance, pod_namespace, pod_container_name)) > (4.2 * 1024 * 1024 * 1024)
      for: 10m
      labels:
        owner: retail-b2b
        severity: critical
      annotations:
        identifier: '{{ $labels.pod_namespace }}/{{$labels.pod_container_name}}/{{ $labels.env }}/{{ $labels.role }}/{{ $labels.instance }}'
        description: 'Critical: Memory Usage exceeds 70%. `{{ $labels.pod_namespace }}/{{$labels.pod_container_name}}/{{ $labels.role }}/{{ $labels.instance }}/{{ $labels.env }}`'
        summary: 'Memory usage is high: `{{ $labels.pod_namespace }}/{{$labels.pod_container_name}}/{{ $labels.role }}/{{ $labels.instance }}/{{ $labels.env }}`'
    - alert: b2b-inventoryupdates-ish-JvmUsageAlert-Stg
      expr: (sum(jvm_memory_used_bytes{job="b2b-inventoryupdates-ish", env="stg"}) by (role, env, instance)) > (3 * 1024 * 1024 * 1024)
      for: 5m
      labels:
        owner: retail-b2b
        severity: warning
      annotations:
        identifier: '{{ $labels.env }}/{{ $labels.role }}/{{ $labels.instance }}'
        description: 'Warning: JVM Heap usage exceeds 60%. `{{ $labels.env }}/{{ $labels.role }}/{{ $labels.instance }}`'
        summary: 'JVm Heap usage is high: `{{ $labels.env }}/{{ $labels.role }}/{{ $labels.instance }}`'
    - alert: b2b-inventoryupdates-ish-JvmUsageAlert-Stg
      expr: (sum(jvm_memory_used_bytes{job="b2b-inventoryupdates-ish", env="stg"}) by (role, env, instance)) > (5.4 * 1024 * 1024 * 1024)
      for: 10m
      labels:
        owner: retail-b2b
        severity: critical
      annotations:
        identifier: '{{ $labels.env }}/{{ $labels.role }}/{{ $labels.instance }}'
        description: 'Critical: JVM Heap usage exceeds 80%. `{{ $labels.env }}/{{ $labels.role }}/{{ $labels.instance }}`'
        summary: 'JVM Heap usage is very high: `{{ $labels.env }}/{{ $labels.role }}/{{ $labels.instance }}`'

- name: b2b.inventoryupdates.ish.npd.drc.rules
  rules:
    - alert: b2b-inventoryupdates-ish-PodDown-NPD-DRC
      expr: (sum(kube_pod_container_info{container="b2b-inventoryupdates-ish", namespace="stg", env="npd-drc"}) by (role, env, namespace, container)) < 3 OR absent(kube_pod_container_info{container="b2b-inventoryupdates-ish", role="eks", env="npd-drc", namespace="stg"}) == 1
      for: 2m
      labels:
        owner: retail-b2b
        severity: warning
      annotations:
        identifier: '{{ $labels.role }}/{{ $labels.env}}/{{ $labels.namespace}}'
        description: 'Warning: One or more pod(s) for {{ $labels.container }} in {{ $labels.namespace }} seems to be down. Current pod count is {{ $value }}'
        summary: 'Host {{ $labels.container }} has not been reachable for 2 minutes'
    - alert: b2b-inventoryupdates-ish-PodDown-NPD-DRC
      expr: (sum(kube_pod_container_info{container="b2b-inventoryupdates-ish", namespace="stg", env="npd-drc"}) by (role, env, namespace, container)) < 3 OR absent(kube_pod_container_info{container="b2b-inventoryupdates-ish", role="eks", env="npd-drc", namespace="stg"}) == 1
      for: 5m
      labels:
        owner: retail-b2b
        severity: critical
      annotations:
        identifier: '{{ $labels.role }}/{{ $labels.env}}/{{ $labels.namespace}}'
        description: 'Critical: One or more pod(s) for {{ $labels.container }} in {{ $labels.namespace }} seems to be down. Current pod count is {{ $value }}'
        summary: 'Host {{ $labels.container }} has not been reachable for 5 minutes'
    - alert: b2b-inventoryupdates-ish-AllPodDown-NPD-DRC
      expr: (sum(kube_pod_container_info{container="b2b-inventoryupdates-ish", namespace="stg", env="npd-drc"}) by (role, env, namespace, container)) == 0 OR absent(kube_pod_container_info{container="b2b-inventoryupdates-ish", role="eks", env="npd-drc", namespace="stg"}) == 1
      for: 2m
      labels:
        owner: retail-b2b
        severity: warning
      annotations:
        identifier: '{{ $labels.role }}/{{ $labels.env}}/{{ $labels.namespace}}'
        description: 'Warning: All Pods for {{ $labels.container }} in {{ $labels.namespace }} seems to be down. Current pod count is {{ $value }}'
        summary: 'Host {{ $labels.container }} has not been reachable for 2 minutes'
    - alert: b2b-inventoryupdates-ish-AllPodDown-NPD-DRC
      expr: (sum(kube_pod_container_info{container="b2b-inventoryupdates-ish", namespace="stg", env="npd-drc"}) by (role, env, namespace, container)) == 0 OR absent(kube_pod_container_info{container="b2b-inventoryupdates-ish", role="eks", env="npd-drc", namespace="stg"}) == 1
      for: 5m
      labels:
        owner: retail-b2b
        severity: critical
      annotations:
        identifier: '{{ $labels.role }}/{{ $labels.env}}/{{ $labels.namespace}}'
        description: 'Critical: All Pods for {{ $labels.container }} in {{ $labels.namespace }} seems to be down. Current pod count is {{ $value }}'
        summary: 'Host {{ $labels.container }} has not been reachable for 5 minutes'
    - alert: b2b-inventoryupdates-ish-CpuUsageAlert-NPD-DRC
      expr: (kube_metrics_server_pods_cpu{pod_container_name="b2b-inventoryupdates-ish", pod_namespace="stg", env="npd-drc"} / (1000000 * 1000)) > 2.8
      for: 5m
      labels:
        owner: retail-b2b
        severity: warning
      annotations:
        identifier: '{{ $labels.pod_namespace }}/{{ $labels.env }}/{{ $labels.role }}/{{ $labels.instance }}'
        description: 'Warning: CPU Usage exceeds 70%. `{{ $labels.pod_namespace }}/{{ $labels.role }}/{{ $labels.instance }}`'
        summary: 'CPU usage is high: `{{ $labels.pod_namespace }}/{{ $labels.role }}/{{ $labels.instance }}`'
    - alert: b2b-inventoryupdates-ish-CpuUsageAlert-NPD-DRC
      expr: (kube_metrics_server_pods_cpu{pod_container_name="b2b-inventoryupdates-ish", pod_namespace="stg", env="npd-drc"} / (1000000 * 1000)) > 3.6
      for: 10m
      labels:
        owner: retail-b2b
        severity: critical
      annotations:
        identifier: '{{ $labels.pod_namespace }}/{{ $labels.env }}/{{ $labels.role }}/{{ $labels.instance }}'
        description: 'Critical: CPU Usage exceeds 90%. `{{ $labels.pod_namespace }}/{{ $labels.role }}/{{ $labels.instance }}`'
        summary: 'CPU usage is very high: `{{ $labels.pod_namespace }}/{{ $labels.role }}/{{ $labels.instance }}`'
    - alert: b2b-inventoryupdates-ish-MemoryUsageAlert-NPD-DRC
      expr: (avg(kube_metrics_server_pods_mem{pod_container_name="b2b-inventoryupdates-ish", pod_namespace="stg", env="npd-drc"}) by (role, env, instance, pod_namespace, pod_container_name)) > (4.2 * 1024 * 1024 * 1024)
      for: 5m
      labels:
        owner: retail-b2b
        severity: warning
      annotations:
        identifier: '{{ $labels.pod_namespace }}/{{$labels.pod_container_name}}/{{ $labels.env }}/{{ $labels.role }}/{{ $labels.instance }}'
        description: 'warning: Memory Usage exceeds 70%. `{{ $labels.pod_namespace }}/{{$labels.pod_container_name}}/{{ $labels.role }}/{{ $labels.instance }}/{{ $labels.env }}`'
        summary: 'Memory usage is high: `{{ $labels.pod_namespace }}/{{$labels.pod_container_name}}/{{ $labels.role }}/{{ $labels.instance }}/{{ $labels.env }}`'
    - alert: b2b-inventoryupdates-ish-MemoryUsageAlert-NPD-DRC
      expr: (avg(kube_metrics_server_pods_mem{pod_container_name="b2b-inventoryupdates-ish", pod_namespace="stg", env="npd-drc"}) by (role, env, instance, pod_namespace, pod_container_name)) > (4.2 * 1024 * 1024 * 1024)
      for: 10m
      labels:
        owner: retail-b2b
        severity: critical
      annotations:
        identifier: '{{ $labels.pod_namespace }}/{{$labels.pod_container_name}}/{{ $labels.env }}/{{ $labels.role }}/{{ $labels.instance }}'
        description: 'Critical: Memory Usage exceeds 70%. `{{ $labels.pod_namespace }}/{{$labels.pod_container_name}}/{{ $labels.role }}/{{ $labels.instance }}/{{ $labels.env }}`'
        summary: 'Memory usage is high: `{{ $labels.pod_namespace }}/{{$labels.pod_container_name}}/{{ $labels.role }}/{{ $labels.instance }}/{{ $labels.env }}`'
